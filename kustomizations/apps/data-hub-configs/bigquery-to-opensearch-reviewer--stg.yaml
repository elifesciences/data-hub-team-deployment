bigQueryToOpenSearch:
  - dataPipelineId: bigquery_to_opensearch_data_pipeline_reviewer
    target:
      openSearch:
        hostname: 'opensearch-staging'
        port: 9200
        timeout: 120
        verifyCertificates: False
        secrets:
          parametersFromFile:
            - parameterName: username
              filePathEnvName: OPENSEARCH_USERNAME_FILE_PATH
            - parameterName: password
              filePathEnvName: OPENSEARCH_PASSWORD_FILE_PATH
        indexName: 'reviewer_v1'
        updateIndexSettings: False
        updateMappings: True
        operationMode: 'update'
        upsert: True
        indexSettings:
          # Note: These settings can usually only be applied to a new index.
          mappings:
            properties:
                person_id:
                  type: "keyword"
    source:
      bigQuery:
        projectName: 'elife-data-pipeline'
        sqlQuery: |-
          SELECT
            Person_ID AS person_id,
            Name AS name,
            Email AS email,
            Institution AS institution,
            ARRAY(SELECT Subject_Area_Name FROM UNNEST(Subject_Areas)) AS subject_areas,
            ARRAY(SELECT Keyword FROM UNNEST(Keywords)) AS keywords,
            ARRAY(SELECT Role_Name FROM UNNEST(Roles)) AS role_names,
            Person.Is_Person_Active,
            Updated_Timestamp AS updated_timestamp
          FROM `elife-data-pipeline.prod.mv_Editorial_Person` AS Person
          WHERE ARRAY_LENGTH(Keywords) > 0
            AND ARRAY_LENGTH(Subject_Areas) > 0
            AND Is_Person_Active
    fieldNamesFor:
      id: person_id
      timestamp: updated_timestamp
    state:
      initialState:
        startTimestamp: '2012-01-01+00:00'
      stateFile:
        bucketName: '{ENV}-elife-data-pipeline'
        objectName: 'airflow-config/bigquery-to-opensearch/{ENV}-state-reviewer.json'
    batchSize: 100
